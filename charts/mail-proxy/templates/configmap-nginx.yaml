kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ include "mail-proxy.fullname" . }}
  labels:
    {{- include "mail-proxy.labels" . | nindent 4 }}
data:
  nginx.conf: |-
    # Almost default nginx.conf, with an added include at the bottom for mail
    # We leave the http in place for health checks and auth requests
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;


    events {
        worker_connections  1024;
    }
    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
        log_format mailAuth '[$time_local] "$http_Client_IP" "$sent_http_Auth_Status" "$http_Auth_User" $status "$http_user_agent"' ;

        access_log  /dev/stdout main;

        sendfile        on;
        #tcp_nopush     on;

        keepalive_timeout  65;

        #gzip  on;

        include /etc/nginx/conf.d/*.conf;
    }
    include /etc/nginx/mail.conf;
  mail.conf: |-
    mail {
      server_name {{  .Values.mail.hostname }};
      # apache external backend
      auth_http   127.0.0.1:{{ .Values.service.port }}/auth/mailauth.php;
      proxy       on;
      proxy_pass_error_message on;

      imap_capabilities "IMAP4rev1" "UIDPLUS" "IDLE" "LITERAL +" "QUOTA";

      pop3_auth plain apop cram-md5;
      pop3_capabilities "LAST" "TOP" "USER" "PIPELINING" "UIDL";

      smtp_auth         login plain;
    #  smtp_auth         login plain cram-md5;
      smtp_capabilities "SIZE {{ .Values.mail.maxMessageSize }}" ENHANCEDSTATUSCODES 8BITMIME DSN;

      ssl_certificate       /etc/nginx/ssl/tls.crt;
      ssl_certificate_key   /etc/nginx/ssl/tls.key;

      error_log /dev/stdout error;

    {{- with .Values.mail.all }}
      {{- if .imap }}
      server {
        listen              143 proxy_protocol;
        protocol            imap;
        starttls            on;
        auth_http_header    X-Auth-Port 143;
        auth_http_header    User-Agent "Nginx IMAP4 proxy";
        set_real_ip_from    {{ .proxyLBrange }};
      }
      {{- end }}

      {{- if .imaps }}
      server {
        listen              993 ssl proxy_protocol;
        protocol            imap;
        auth_http_header    X-Auth-Port 993;
        auth_http_header    User-Agent "Nginx IMAP4s proxy";
        set_real_ip_from    {{ .proxyLBrange }};
      }
      {{- end }}

      {{- if .pop3 }}
      server {
        listen              110 proxy_protocol;
        protocol            pop3;
        starttls            on;
        pop3_auth           plain;
        auth_http_header    X-Auth-Port 110;
        auth_http_header    User-Agent "Nginx POP3 proxy";
        set_real_ip_from    {{ .proxyLBrange }};
      }
      {{- end }}

      {{- if .pop3s }}
      server {
        listen              995 ssl proxy_protocol;
        protocol            pop3;
        pop3_auth           plain;
        auth_http_header    X-Auth-Port 995;
        auth_http_header    User-Agent "Nginx POP3s proxy";
        set_real_ip_from    {{ .proxyLBrange }};
      }
      {{- end }}

      {{- if .smtps }}
      server  {
        listen              587 proxy_protocol;
        protocol            smtp;
        starttls            on;
        auth_http_header    X-Auth-Port 587;
        auth_http_header    User-Agent "Nginx SMTP proxy";
        xclient             off;
        set_real_ip_from    {{ .proxyLBrange }};
      }
      {{- end }}
    {{- end }}
    }
  healthcheck: |-
    We are alive
  default.conf: |-
    server {
      listen       {{ .Values.service.port }};
      server_name  _;
      root   /usr/share/nginx/html;
      location = /healthz {
        log_not_found off;
        access_log off;
      }
      location /auth {
        access_log     /dev/stdout mailAuth;
        include        fastcgi_params;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass   {{ .Values.mail.phpAuth.host }}:{{ .Values.mail.phpAuth.port }};
        fastcgi_param  SCRIPT_FILENAME  /var/www/html$fastcgi_script_name;
        fastcgi_index  index.php;
      }
      location / {
        index  index.html index.htm;
      }
      error_page   500 502 503 504  /50x.html;
    }
